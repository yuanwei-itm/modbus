<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ruoyi.system.mapper.ModbusDataMapper">
    <!-- 结果集映射：数据库下划线→实体驼峰 -->
    <resultMap id="ModbusDataResultMap" type="com.ruoyi.system.domain.ModbusData">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/> <!-- 新增：映射device_id -->
        <result column="slave_id" property="slaveId"/>
        <result column="temperature" property="temperature"/>
        <result column="humidity" property="humidity"/>
        <result column="read_time" property="readTime"/>
        <result column="device_name" property="deviceName"/>
    </resultMap>

    <!--单条插入-->
    <insert id="insert" parameterType="com.ruoyi.system.domain.ModbusData">
        INSERT INTO modbus_data (device_id, slave_id, temperature, humidity, read_time)
        VALUES (#{deviceId},#{slaveId}, #{temperature}, #{humidity}, #{readTime})
    </insert>

    <!--批量插入-->
    <insert id="batchInsertModbusData" parameterType="java.util.List">
        INSERT INTO modbus_data (device_id, slave_id, temperature, humidity, read_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.deviceId}, #{item.slaveId}, #{item.temperature}, #{item.humidity}, #{item.readTime})
        </foreach>
    </insert>

    <!-- 按时间范围查询历史数据，联表查设备名称 -->
    <select id="selectHistoryDataByTimeRange" resultMap="ModbusDataResultMap">
        SELECT
        t1.id, t1.slave_id, t1.temperature, t1.humidity, t1.read_time,
        COALESCE(t2.device_name, '未知设备') AS device_name
        FROM modbus_data t1
        LEFT JOIN device_archive t2 ON t1.slave_id = t2.slave_id AND t2.status = 0
        <where>
            <if test="startTime != null">t1.read_time &gt;= #{startTime}</if>
            <if test="endTime != null">AND t1.read_time &lt;= #{endTime}</if>
            <if test="slaveId != null">AND t1.slave_id = #{slaveId}</if>
        </where>
        ORDER BY  t1.read_time DESC,t2.device_name ASC
    </select>

    <!-- 实时数据查询SQL -->
    <select id="selectLatestDataByAllSlaveIds" resultMap="ModbusDataResultMap">
        SELECT
            t1.id, t1.slave_id, t1.temperature, t1.humidity, t1.read_time,
            COALESCE(t2.device_name, '未知设备') AS device_name
        FROM modbus_data t1
                 -- 关联设备档案表，拿到设备的唯一device_id
                 LEFT JOIN device_archive t2
                           ON t1.slave_id = t2.slave_id
                               AND t2.status = 0 -- 只关联启用的设备
                 INNER JOIN (
            -- 子查询：按device_id分组，取每个设备的最新记录（唯一）
            SELECT
                t2.device_id,
                MAX(t1.read_time) AS max_time, -- 最新采集时间
                MAX(t1.id) AS max_id -- 避免同时间多条记录，取最大id
            FROM modbus_data t1
                     LEFT JOIN device_archive t2
                               ON t1.slave_id = t2.slave_id
                                   AND t2.status = 0
            WHERE t2.device_id IS NOT NULL -- 过滤无对应设备的记录
            GROUP BY t2.device_id -- 按设备唯一标识分组（5个device_id=5组）
        ) t3 ON t2.device_id = t3.device_id
            AND t1.read_time = t3.max_time
            AND t1.id = t3.max_id
        WHERE t2.device_id IS NOT NULL -- 只返回有对应设备的记录
        ORDER BY t2.device_name ASC -- 按设备名称排序
    </select>

    <select id="countByDeviceIdAndReadTime" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM modbus_data
        WHERE device_id = #{deviceId}
          AND read_time = #{readTime}
    </select>
</mapper>