<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ruoyi.datacontrol.mapper.ModbusDataMapper">
    <!-- 结果集映射：数据库下划线→实体驼峰 -->
    <resultMap id="ModbusDataResultMap" type="com.ruoyi.datacontrol.domain.ModbusData">
        <id column="id" property="id"/>
        <result column="slave_id" property="slaveId"/>
        <result column="device_id" property="deviceId"/>
        <result column="temperature" property="temperature"/>
        <result column="humidity" property="humidity"/>
        <result column="read_time" property="readTime"/>
        <result column="device_name" property="deviceName"/>
    </resultMap>

    <!--基础查询字段-->
    <sql id="selectModbusDataVo">
        SELECT
            t1.id, t1.device_id, t1.slave_id, t1.temperature, t1.humidity, t1.read_time,
            COALESCE(t2.device_name, '未知设备') AS device_name  -- 设备名兜底，避免空值
        FROM modbus_data t1
                 LEFT JOIN device_archive t2
                           ON t1.slave_id = t2.slave_id          -- 从站ID关联
                               AND t1.device_id = t2.device_id       -- 设备ID关联
                               AND t2.status = 0                     -- 仅关联启用状态的设备（status=0）
    </sql>

    <!--批量插入-->
    <insert id="batchInsertModbusData" parameterType="java.util.List">
        INSERT INTO modbus_data (device_id, slave_id, temperature, humidity, read_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.deviceId}, #{item.slaveId}, #{item.temperature}, #{item.humidity}, #{item.readTime})
        </foreach>
    </insert>

    <!-- 历史数据查询SQL -->
    <select id="selectModbusDataList" parameterType="com.ruoyi.datacontrol.domain.ModbusData" resultMap="ModbusDataResultMap">
        <include refid="selectModbusDataVo"/>
        <where>
            <if test="slaveId != null">
                AND t1.slave_id = #{slaveId}
            </if>
            <if test="deviceId != null and deviceId != ''">
                AND t1.device_id = #{deviceId}
            </if>
            <if test="params.startTime != null">
                AND t1.read_time &gt;= #{params.startTime}
            </if>
            <if test="params.endTime != null">
                AND t1.read_time &lt;= #{params.endTime}
            </if>
        </where>
        ORDER BY t1.read_time DESC
    </select>

    <!-- 实时数据查询SQL -->
    <select id="selectLatestDataByAllSlaveIds" resultMap="ModbusDataResultMap">
        SELECT
            t1.id, t1.slave_id, t1.device_id, t1.temperature, t1.humidity, t1.read_time,
            COALESCE(t2.device_name, '未知设备') AS device_name  -- 设备名兜底
        FROM modbus_data t1
                 -- 子查询：按device_id+slave_id分组，取每组最大ID（最新数据）
                 INNER JOIN (
            SELECT MAX(id) AS max_id
            FROM modbus_data
            GROUP BY device_id, slave_id
        ) t3 ON t1.id = t3.max_id
            -- 关联设备档案表获取设备名称
                 LEFT JOIN device_archive t2
                           ON t1.slave_id = t2.slave_id AND t1.device_id = t2.device_id AND t2.status = 0
        WHERE t2.device_id IS NOT NULL  -- 过滤无对应设备档案的记录
        ORDER BY t2.device_name ASC    -- 按设备名称升序排列
    </select>

    <select id="countByDeviceIdAndReadTime" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM modbus_data
        WHERE device_id = #{deviceId}
          AND read_time = #{readTime}
    </select>

</mapper>